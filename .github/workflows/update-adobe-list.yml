name: 自动更新Adobe列表forAdguardHome v5.2
on:
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:

jobs:
  update-list:
    runs-on: ubuntu-latest
    steps:
      - name: 下载并处理列表
        run: |
          # 1. 下载原始列表
          SOURCE_URL="https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/refs/heads/meta/geo/geosite/adobe-activation.list"
          TARGET_FILE="adobe_acti_bykim.list"
          
          echo "下载原始列表..."
          curl -sSL $SOURCE_URL > raw.txt
          
          # 2. 处理格式（加||前缀、……后缀）
          echo "处理列表格式..."
          > $TARGET_FILE  # 清空目标文件
          while IFS= read -r line; do
            if [[ -n "$line" && ! "$line" =~ ^# ]]; then
              echo "||$line^" >> $TARGET_FILE
            fi
          done < raw.txt
          
          # 3. 输出处理结果（验证）
          echo "处理完成，总行数：$(wc -l < $TARGET_FILE)"
          rm -f raw.txt

      - name: 用 GitHub API 推送文件（核心解决权限问题）
        env:
          PAT: ${{ secrets.PAT_TOKEN }}
          REPO: trasne/workflow  # 你的仓库：用户名/仓库名
          FILE_PATH: adobe_acti_bykim.list
        run: |
          # 读取文件内容并 Base64 编码（GitHub API 要求）
          CONTENT=$(base64 -w 0 $FILE_PATH)
          
          # 获取文件的 SHA（用于更新，避免重复创建）
          SHA=$(curl -s -H "Authorization: token $PAT" \
            "https://api.github.com/repos/$REPO/contents/$FILE_PATH" \
            | jq -r '.sha // "null"')
          
          # 构造请求体
          if [ "$SHA" = "null" ]; then
            # 文件不存在，创建新文件
            PAYLOAD=$(jq -n \
              --arg path "$FILE_PATH" \
              --arg content "$CONTENT" \
              --arg message "自动更新 Adobe 列表（$(date +'%Y-%m-%d %H:%M:%S')）" \
              '{path: $path, content: $content, message: $message}')
          else
            # 文件已存在，更新文件
            PAYLOAD=$(jq -n \
              --arg path "$FILE_PATH" \
              --arg content "$CONTENT" \
              --arg sha "$SHA" \
              --arg message "自动更新 Adobe 列表（$(date +'%Y-%m-%d %H:%M:%S')）" \
              '{path: $path, content: $content, sha: $sha, message: $message}')
          fi
          
          # 调用 GitHub API 推送
          RESPONSE=$(curl -s -X PUT \
            -H "Authorization: token $PAT" \
            -H "Content-Type: application/json" \
            "https://api.github.com/repos/$REPO/contents/$FILE_PATH" \
            -d "$PAYLOAD")
          
          # 验证结果
          if echo "$RESPONSE" | jq -e '.content' > /dev/null; then
            echo "✅ 文件推送成功！"
          else
            echo "❌ 推送失败，响应：$RESPONSE"
            exit 1
          fi
